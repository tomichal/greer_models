---
title: "Model Fitting Combo_nieve_cohort"
author: "Greer Waldrop"
date: "2/13/2025"
output: html_document
---

#you will need to input your paths in the first chunk and in all the chunks for the models you need to input your data in the model matrix and then the last chuck you need to put the output path for the csv of the model fitting results; you will also need the tsv file of "biomart_protein_coding_genes_withgeneinfo.tsv" loaded into your working directory#

```{r setup, include=FALSE}
library(BiocParallel)
library(rmarkdown)
library(knitr)
library(zinbwave)
library(readr)
library(tidyr)
library(tibble)
library(biomaRt)
library(dplyr)

knitr::opts_chunk$set(echo = TRUE)
```

```{r Initialize}
setwd("~/dev/r/greer_models")
source("load_data.R")
source("prepare_data.R")
source("summarized_experiment.R")
source("run_model.R")

loaded_data <- load_data(
  "./input/meta_data_lazar.csv",
  "./input/gene_count_lazar_1000.csv",
  "./input/pc_genes.csv"
)
meta_MS <- loaded_data$meta_MS
matrix_ms_predrop <- loaded_data$matrix_ms_predrop
pc_genes <- loaded_data$pc_genes

prepared_data <- prepare_data(matrix_ms_predrop, meta_MS)

meta_MS <- prepared_data$meta_MS
matrix_combo_ms_ns_drop <- prepared_data$matrix_combo_ms_ns_drop

se_combo_drop_nieve <- summarized_experiment(matrix_combo_ms_ns_drop, meta_MS)
```


```{r Model Definitions}
meta_ms_cols <- c(
  "age_at_csf",
  "sex",
  "race",
  "ethnicity",
  "enhancing",
  "csf_wbc",
  "immunetherapyattimeoflp",
  "coll_to_seq",
  "percentzero",
  "totaltranscripts",
  "numnonzero",
  "pleocytosis"
)

combinations <- list()
model_definitions <- list()
sequence <- 1:length(meta_ms_cols)
for (i in sequence) {
  combination_matrix <- combn(meta_ms_cols, i, simplify = TRUE)
  new_combinations <- split(combination_matrix, col(combination_matrix))
  combinations <- c(combinations, new_combinations)
}
for (attrs in combinations) {
  formula_x <- reformulate(termlabels = paste0("se_combo_drop_nieve$", attrs))
  model_definitions <- c(
    model_definitions,
    list(
      list(
        attrs = attrs,
        name = paste(attrs, collapse = "_"),
        title = paste(attrs, collapse = " + "),
        formula_x = formula_x
      )
    )
  )
}
```

```{r Running Models and Making Table for AIC and ll}
num_rows <- 7
fit_df <- data.frame(matrix(ncol = 0, nrow = num_rows))
row_names <- c("Models", "ZI AIC", "ZI -ll", "ZI-df", "NB AIC", "NB -ll", "NB df")
rownames(fit_df) <- row_names

# for (i in list(118,117,1,2)) {
for (i in seq_along(model_definitions)) {
  for (formula_v in list(NULL, (~pc_genes$gcc + pc_genes$length))) {
    name <- if (!is.null(formula_v)) paste(model_definitions[[i]]$name, "with_pc_genes", sep = "_") else model_definitions[[i]]$name
    title <- if (!is.null(formula_v)) paste(model_definitions[[i]]$title, "with pc genes", sep = " ") else model_definitions[[i]]$title
    formula_x <- model_definitions[[i]]$formula_x

    result <- run_model(
      Y = se_combo_drop_nieve,
      xFormula = formula_x,
      maxIterOptimize = 400,
      V = formula_v
    )
    fit_df[[paste0("model_", name, "_combo_drop_nieve")]] <- c(
      title,
      result$ZI_aic,
      result$ZI_ll,
      result$ZI_df,
      result$NB_aic,
      result$NB_ll,
      result$NB_df
    )
  }
}

row1 <- fit_df[3, -14]
row2 <- fit_df[6, -14]
row1 <- as.numeric(row1)
row2 <- as.numeric(row2)

# Perform subtraction, this will give you the difference in the -2 logliklihood wihch is the statistic which you could in theory run a LR test on but these models aren't nested so cant technically do it 
result_row <- 2 * (row1 - row2)

result_df_combo_drop_nieve_cohort <- as.data.frame(t(result_row))
colnames(result_df_combo_drop_nieve_cohort) <- colnames(fit_df)  # Match column names
rownames(result_df_combo_drop_nieve_cohort)[1] <- "Difference in LL"

# Bind the new row (differce in the negative 2 ll) to the original DataFrame
combo_ModelCompare_drop_nieve_cohort <- rbind(fit_df, result_df_combo_drop_nieve_cohort)

# Create './output' folder if it does not exist
if (!dir.exists("./output")) {
  dir.create("./output", showWarnings = FALSE)
}

combo_ModelCompare_drop_nieve_cohort <- combo_ModelCompare_drop_nieve_cohort[,
        order(as.numeric(combo_ModelCompare_drop_nieve_cohort["ZI AIC", ]))]

write.csv(combo_ModelCompare_drop_nieve_cohort, file = "./output/model_fiting_table_combo_drop_nieve_cohort_NEW.csv", row.names = TRUE)

```



