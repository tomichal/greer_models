---
title: "Model Fitting Combo_nieve_cohort"
author: "Greer Waldrop"
date: "2/13/2025"
output: html_document
---

#you will need to input your paths in the first chunk and in all the chunks for the models you need to input your data in the model matrix and then the last chuck you need to put the output path for the csv of the model fitting results; you will also need the tsv file of "biomart_protein_coding_genes_withgeneinfo.tsv" loaded into your working directory#

```{r setup, include=FALSE}
library(BiocParallel)
library(rmarkdown)
library(knitr)
library(zinbwave)
library(readr)
library(tidyr)
library(tibble)
library(biomaRt)
library(dplyr)

knitr::opts_chunk$set(echo = TRUE)
```

```{r load in MS Data}
setwd("~/dev/r/greer_models")
source("load_data.R")
loaded_data <- load_data(
  "./data/gene_count_lazar_1000.csv",
  "./data/meta_data_lazar.csv"
)
meta_MS <- loaded_data$meta_MS
matrix_ms_predrop <- loaded_data$matrix_ms_predrop
```

```{r combine ms and ns matrix, and drop zero genes and making some edits to variables so there is no missing variables}
source("prepare_data.R")
prepared_data <- prepare_data(matrix_ms_predrop, meta_MS)

meta_MS <- prepared_data$meta_MS
matrix_combo_ms_ns_drop <- prepared_data$matrix_combo_ms_ns_drop
```

```{r Make a summarized Experiment object}
source("summarized_experiment.R")
se_combo_drop_nieve <- summarized_experiment(matrix_combo_ms_ns_drop, meta_MS)
```

```{r import run_model function}
source("run_model.R")

# Model definitions
## Before modifying the Y data
batch_1 <- list(
  # Crude Model (Model 1, univariate age)
  list(
    title = "Cohort + Age",
    xFormula = (~se_combo_drop_nieve$cohort + se_combo_drop_nieve$age_at_csf),
    maxIterOptimize = 400
  ),
  # Model2 (univariate batch)
  list(
    title = "Cohort + Batch",
    xFormula = (~se_combo_drop_nieve$cohort + se_combo_drop_nieve$batch),
    maxIterOptimize = 400
  ),
  #Model 3 (univariate non-zero gene count)
  list(
    title = "Cohort +Non Zero Gene Counts",
    xFormula = (~se_combo_drop_nieve$cohort + se_combo_drop_nieve$Quartilenonzero),
    maxIterOptimize = 25
  ),
  #Model 4 univariate totalcounts
  list(
    title = "Cohort + Total Gene Counts",
    xFormula = (~se_combo_drop_nieve$cohort + se_combo_drop_nieve$Quartiletotal),
    maxIterOptimize = 400
  ),
  #Model 5 (nonzero and totaltranscripts)
  list(
    title = "Cohort + Non Zero Gene Counts + Total Gene Counts",
    xFormula = (~se_combo_drop_nieve$cohort +
      se_combo_drop_nieve$Quartiletotal +
      se_combo_drop_nieve$Quartilenonzero),
    maxIterOptimize = 400
  )

)
```

#Model 11 (freezer time)
```{r model 11 univariate freezer time}
result_11 <- run_model(Y = se_combo_drop_nieve, xFormula = (~se_combo_drop_nieve$cohort + se_combo_drop_nieve$Quartilefreezer))
```

#Model 12 (pleocytosis)
```{r model 12 univariate pleocytosis}
result_12 <- run_model(Y = se_combo_drop_nieve, xFormula = (~se_combo_drop_nieve$cohort + se_combo_drop_nieve$pleocytosis))
```

#Model 14 (enhancing)
```{r model 14 enhancing}
result_14 <- run_model(Y = se_combo_drop_nieve, xFormula = (~se_combo_drop_nieve$cohort + se_combo_drop_nieve$enhancing))
```

#Model 6 (nonzero and totaltranscripts and batch)
```{r model 6 nonzero, totaltranscripts and batch}
result_6 <- run_model(Y = se_combo_drop_nieve, xFormula = (~se_combo_drop_nieve$cohort +
  se_combo_drop_nieve$Quartiletotal +
  se_combo_drop_nieve$Quartilenonzero +
  se_combo_drop_nieve$batch))
```


#Model 7 adding gene level data
```{r model 7 adding gene level data}
mart <- useMart("ensembl")
mart <- useDataset("hsapiens_gene_ensembl", mart = mart)

bm <- getBM(
  attributes = c('hgnc_symbol', 'start_position', 'end_position', 'percentage_gene_gc_content'),
  filters = 'hgnc_symbol',
  values = rownames(se_combo_drop_nieve),
  mart = mart
)
bm$length <- bm$end_position - bm$start_position
len <- tapply(bm$length, bm$hgnc_symbol, mean)
len <- len[rownames(se_combo_drop_nieve)]
gcc <- tapply(bm$percentage_gene_gc_content, bm$hgnc_symbol, mean)
gcc <- gcc[rownames(se_combo_drop_nieve)]

rowData(se_combo_drop_nieve) <- data.frame(gccontent = gcc, length = len)

result_7 <- run_model(
  Y = se_combo_drop_nieve,
  xFormula = (
    ~se_combo_drop_nieve$cohort +
      se_combo_drop_nieve$Quartilenonzero +
      se_combo_drop_nieve$Quartiletotal
  ),
  V = (~pc_genes$gcc + pc_genes$length)
)
```

#Model 8 adding gender and age with gene level data
```{r model 8 }
result_8 <- run_model(
  Y = se_combo_drop_nieve,
  xFormula = (
    ~se_combo_drop_nieve$cohort +
      se_combo_drop_nieve$sex +
      se_combo_drop_nieve$race +
      se_combo_drop_nieve$Quartiletotal +
      se_combo_drop_nieve$Quartilenonzero +
      se_combo_drop_nieve$age_at_csf
  ),
  V = (~pc_genes$gcc + pc_genes$length)
)
```
#Model 9 adding gender and age without gene level data
```{r model 9 }

result_9 <- run_model(
  Y = se_combo_drop_nieve,
  xFormula = (
    ~se_combo_drop_nieve$cohort +
      se_combo_drop_nieve$sex +
      se_combo_drop_nieve$race +
      se_combo_drop_nieve$Quartilenonzero +
      se_combo_drop_nieve$Quartiletotal +
      se_combo_drop_nieve$age_at_csf
  )
)
```

#Model 10 adding gender and age without gene level data and without total transcripts
```{r model 10 }
result_10 <- run_model(
  Y = se_combo_drop_nieve,
  xFormula = (
    ~se_combo_drop_nieve$cohort +
      se_combo_drop_nieve$sex +
      se_combo_drop_nieve$race +
      se_combo_drop_nieve$Quartilenonzero +
      se_combo_drop_nieve$age_at_csf
  )
)
```

#Making Table for AIC and ll
```{r making table output of AIC other parameters}
num_rows <- 7
fit_df <- data.frame(matrix(ncol = 0, nrow = num_rows))
row_names <- c("Models", "ZI AIC", "ZI -ll", "ZI-df", "NB AIC", "NB -ll", "NB df")
rownames(fit_df) <- row_names

for (i in seq_along(batch_1)) {
  result <- run_model(Y = se_combo_drop_nieve, xFormula = batch_1[[i]]$xFormula)
  fit_df[[paste0("model_", i, "_combo_drop_nieve")]] <- c(
    batch_1[[i]]$title,
    result$ZI_aic,
    result$ZI_ll,
    result$ZI_df,
    result$NB_aic,
    result$NB_ll,
    result$NB_df
  )
}

model_6_combo_drop_nieve <- c(
  "Cohort + Batch + Non Zero Gene Counts + Total Gene Counts + Gene Level",
  result_6$ZI_aic,
  result_6$ZI_ll,
  result_6$ZI_df,
  result_6$NB_aic,
  result_6$NB_ll,
  result_6$NB_df
)
model_7_combo_drop_nieve <- c(
  "Cohort + Non Zero Gene Counts + Total Gene Counts + Gene Level",
  result_7$ZI_aic,
  result_7$ZI_ll,
  result_7$ZI_df,
  result_7$NB_aic,
  result_7$NB_ll,
  result_7$NB_df
)
model_8_combo_drop_nieve <- c(
  "Cohort + Non Zero Gene Counts + Total Gene Counts + Gene Level+ Age + Sex + Race",
  result_8$ZI_aic,
  result_8$ZI_ll,
  result_8$ZI_df,
  result_8$NB_aic,
  result_8$NB_ll,
  result_8$NB_df
)
model_9_combo_drop_nieve <- c(
  "Cohort + Non Zero Gene Counts + Total Gene Counts + Age + Sex + Race",
  result_9$ZI_aic,
  result_9$ZI_ll,
  result_9$ZI_df,
  result_9$NB_aic,
  result_9$NB_ll,
  result_9$NB_df
)
model_10_combo_drop_nieve <- c(
  "Cohort + Non Zero Gene Counts + Age + Sex + Race",
  result_10$ZI_aic,
  result_10$ZI_ll,
  result_10$ZI_df,
  result_10$NB_aic,
  result_10$NB_ll,
  result_10$NB_df
)
model_11_combo_drop_nieve <- c(
  "Cohort + Pleocytosis",
  result_11$ZI_aic,
  result_11$ZI_ll,
  result_11$ZI_df,
  result_11$NB_aic,
  result_11$NB_ll,
  result_11$NB_df
)
model_12_combo_drop_nieve <- c(
  "Cohort + Quartiles of Freezer Time",
  result_12$ZI_aic,
  result_12$ZI_ll,
  result_12$ZI_df,
  result_12$NB_aic,
  result_12$NB_ll,
  result_12$NB_df
)
model_14_combo_drop_nieve <- c(
  "Cohort + Enhancing Lesino within 30 days",
  result_14$ZI_aic,
  result_14$ZI_ll,
  result_14$ZI_df,
  result_14$NB_aic,
  result_14$NB_ll,
  result_14$NB_df
)

fit_df$model1_combo_drop_nieve <- model_1_combo_drop_nieve
fit_df$model2_combo_drop_nieve <- model_2_combo_drop_nieve
fit_df$model3_combo_drop_nieve <- model_3_combo_drop_nieve
fit_df$model4_combo_drop_nieve <- model_4_combo_drop_nieve
fit_df$model11_combo_drop_nieve <- model_11_combo_drop_nieve
fit_df$model12_combo_drop_nieve <- model_12_combo_drop_nieve
fit_df$model14_combo_drop_nieve <- model_14_combo_drop_nieve
fit_df$model5_combo_drop_nieve <- model_5_combo_drop_nieve
fit_df$model6_combo_drop_nieve <- model_6_combo_drop_nieve
fit_df$model7_combo_drop_nieve <- model_7_combo_drop_nieve
fit_df$model8_combo_drop_nieve <- model_8_combo_drop_nieve
fit_df$model9_combo_drop_nieve <- model_9_combo_drop_nieve
fit_df$model10_combo_drop_nieve <- model_10_combo_drop_nieve

row1 <- fit_df[3, -14]
row2 <- fit_df[6, -14]
row1 <- as.numeric(row1)
row2 <- as.numeric(row2)

# Perform subtraction, this will give you the difference in the -2 logliklihood wihch is the statistic which you could in theory run a LR test on but these models aren't nested so cant technically do it 
result_row <- 2 * (row1 - row2)

result_df_combo_drop_nieve_cohort <- as.data.frame(t(result_row))
colnames(result_df_combo_drop_nieve_cohort) <- colnames(fit_df)  # Match column names
rownames(result_df_combo_drop_nieve_cohort)[1] <- "Difference in LL"

# Bind the new row (differce in the negative 2 ll) to the original DataFrame
combo_ModelCompare_drop_nieve_cohort <- rbind(fit_df, result_df_combo_drop_nieve_cohort)

write.csv(combo_ModelCompare_drop_nieve_cohort, file = "./NSvsMS_24_12_30/model_fiting_table_combo_drop_nieve_cohort_NEW.csv", row.names = TRUE)

```



